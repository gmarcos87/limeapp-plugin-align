'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _alignApi = require('./alignApi');

var _Observable = require('rxjs/Observable');

require('rxjs/add/observable/from');

require('rxjs/add/observable/of');

require('rxjs/add/observable/interval');

require('rxjs/add/operator/takeUntil');

require('rxjs/add/operator/mergeMap');

require('rxjs/add/operator/switchMap');

require('rxjs/add/operator/mapTo');

require('rxjs/add/operator/map');

require('rxjs/add/operator/catch');

var _alignConstants = require('./alignConstants');

// LOAD INTERFACES -> Dispatch success and stations loads
var ifaceLoad = function ifaceLoad(action$, _ref, _ref2) {
  var getState = _ref.getState;
  var wsAPI = _ref2.wsAPI;
  return action$.ofType.apply(action$, [_alignConstants.IFACES_LOAD]).mergeMap(function (action) {
    return (0, _alignApi.getInterfaces)(wsAPI, getState().meta.sid);
  }).mergeMap(function (payload) {
    return _Observable.Observable.from([{ type: _alignConstants.IFACES_LOAD_SUCCESS, payload: payload }, { type: _alignConstants.STATIONS_LOAD }]);
  });
};

// LOAD ALL STATIONS -> Dispatch success and Init Align
var allStationsLoad = function allStationsLoad(action$, _ref3, _ref4) {
  var getState = _ref3.getState;
  var wsAPI = _ref4.wsAPI;
  return action$.ofType(_alignConstants.STATIONS_LOAD).mergeMap(function () {
    return (0, _alignApi.getStations)(wsAPI, getState().meta.sid);
  }).map(function (payload) {
    return { type: _alignConstants.STATIONS_LOAD_SUCCESS, payload: payload };
  }).catch(function (error) {
    return _Observable.Observable.of({
      type: 'NOTIFICATION',
      payload: { msg: 'Not stations in interfaces' },
      error: true
    });
  });
};

// CHANGE INTEFACE -> DIspatch get station by interface and select best signal
var ifaceChange = function ifaceChange(action$, _ref5, _ref6) {
  var getState = _ref5.getState;
  var wsAPI = _ref6.wsAPI;
  return action$.ofType(_alignConstants.IFACE_CHANGE).mergeMap(function (action) {
    return (0, _alignApi.getIfaceStation)(wsAPI, getState().meta.sid, action.payload.iface);
  }).map(function (payload) {
    return payload.nodes;
  }).map(function (payload) {
    return { type: _alignConstants.STATIONS_LOAD_SUCCESS, payload: payload };
  }).catch(function (error) {
    return _Observable.Observable.of({
      type: 'NOTIFICATION',
      payload: { msg: 'Not stations in interface' },
      error: true
    });
  });
};

// INIT ALIGN -> Select best node, interface and start timer
var initAlign = function initAlign(action$) {
  return action$.ofType(_alignConstants.STATIONS_LOAD_SUCCESS).map(function (action) {
    return action.payload;
  }).map(function (payload) {
    return payload.sort(function (x, y) {
      return x.signal + y.signal;
    })[0];
  }).mergeMap(function (res) {
    return _Observable.Observable.from([{ type: _alignConstants.STATION_SET, payload: res }, { type: _alignConstants.IFACE_SET, payload: res.iface }, { type: _alignConstants.TIMER_START }]);
  });
};

// GET_SIGNAL -> Update current signal and nodes
var getSignal = function getSignal(action$, _ref7, _ref8) {
  var getState = _ref7.getState;
  var wsAPI = _ref8.wsAPI;
  return action$.ofType(_alignConstants.SIGNAL_GET).switchMap(function () {
    return (0, _alignApi.getStationSignal)(wsAPI, getState().meta.sid, getState().align.currentReading);
  }).map(function (signal) {
    return { type: _alignConstants.SIGNAL_GET_SUCCESS, payload: signal };
  });
};

// TIMER MANAGER
var runTimer = function runTimer(action$, _ref9) {
  var getState = _ref9.getState;
  return action$.ofType(_alignConstants.TIMER_START).mergeMap(function (actions) {
    return _Observable.Observable.interval(getState().meta.interval).takeUntil(action$.ofType(_alignConstants.TIMER_STOP)).map(function () {
      return { type: _alignConstants.SIGNAL_GET };
    });
  });
};

exports.default = { ifaceLoad: ifaceLoad, allStationsLoad: allStationsLoad, ifaceChange: ifaceChange, initAlign: initAlign, getSignal: getSignal, runTimer: runTimer };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hbGlnbkVwaWNzLmpzIl0sIm5hbWVzIjpbImlmYWNlTG9hZCIsImFjdGlvbiQiLCJnZXRTdGF0ZSIsIndzQVBJIiwib2ZUeXBlIiwibWVyZ2VNYXAiLCJhY3Rpb24iLCJtZXRhIiwic2lkIiwicGF5bG9hZCIsImZyb20iLCJ0eXBlIiwiYWxsU3RhdGlvbnNMb2FkIiwibWFwIiwiY2F0Y2giLCJvZiIsIm1zZyIsImVycm9yIiwiaWZhY2VDaGFuZ2UiLCJpZmFjZSIsIm5vZGVzIiwiaW5pdEFsaWduIiwic29ydCIsIngiLCJ5Iiwic2lnbmFsIiwicmVzIiwiZ2V0U2lnbmFsIiwic3dpdGNoTWFwIiwiYWxpZ24iLCJjdXJyZW50UmVhZGluZyIsInJ1blRpbWVyIiwiYWN0aW9ucyIsImludGVydmFsIiwidGFrZVVudGlsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFnQkE7QUFDQSxJQUFNQSxZQUFZLFNBQVpBLFNBQVksQ0FBRUMsT0FBRjtBQUFBLE1BQWFDLFFBQWIsUUFBYUEsUUFBYjtBQUFBLE1BQTJCQyxLQUEzQixTQUEyQkEsS0FBM0I7QUFBQSxTQUNoQkYsUUFBUUcsTUFBUixnQkFBa0IsNkJBQWxCLEVBQ0dDLFFBREgsQ0FDWSxVQUFDQyxNQUFEO0FBQUEsV0FBWSw2QkFBY0gsS0FBZCxFQUFxQkQsV0FBV0ssSUFBWCxDQUFnQkMsR0FBckMsQ0FBWjtBQUFBLEdBRFosRUFFS0gsUUFGTCxDQUVjLFVBQUNJLE9BQUQ7QUFBQSxXQUFhLHVCQUFXQyxJQUFYLENBQWdCLENBQ3BDLEVBQUVDLHlDQUFGLEVBQTZCRixnQkFBN0IsRUFEb0MsRUFFcEMsRUFBRUUsbUNBQUYsRUFGb0MsQ0FBaEIsQ0FBYjtBQUFBLEdBRmQsQ0FEZ0I7QUFBQSxDQUFsQjs7QUFTQTtBQUNBLElBQU1DLGtCQUFrQixTQUFsQkEsZUFBa0IsQ0FB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QUFBLE1BQWFDLFFBQWIsU0FBYUEsUUFBYjtBQUFBLFNBQ2ZELFFBQVFHLE1BQVIsOEJBQ0dDLFFBREgsQ0FDWSxVQUFDMkIsT0FBRCxFQUFhO0FBQ3JCLFdBQU8sdUJBQVdDLFFBQVgsQ0FBb0IvQixXQUFXSyxJQUFYLENBQWdCMEIsUUFBcEMsRUFDSkMsU0FESSxDQUNNakMsUUFBUUcsTUFBUiw0QkFETixFQUVKUyxHQUZJLENBRUE7QUFBQSxhQUFPLEVBQUVGLGdDQUFGLEVBQVA7QUFBQSxLQUZBLENBQVA7QUFHRCxHQUxILENBRGU7QUFBQSxDQUFqQjs7a0JBUWUsRUFBRVgsb0JBQUYsRUFBYVksZ0NBQWIsRUFBOEJNLHdCQUE5QixFQUEyQ0csb0JBQTNDLEVBQXNETSxvQkFBdEQsRUFBaUVJLGtCQUFqRSxFIiwiZmlsZSI6ImFsaWduRXBpY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRJbnRlcmZhY2VzLCBnZXRTdGF0aW9ucywgZ2V0SWZhY2VTdGF0aW9uLCBnZXRTdGF0aW9uU2lnbmFsfSBmcm9tICcuL2FsaWduQXBpJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgJ3J4anMvYWRkL29ic2VydmFibGUvZnJvbSc7XG5pbXBvcnQgJ3J4anMvYWRkL29ic2VydmFibGUvb2YnO1xuaW1wb3J0ICdyeGpzL2FkZC9vYnNlcnZhYmxlL2ludGVydmFsJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvdGFrZVVudGlsJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvbWVyZ2VNYXAnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9zd2l0Y2hNYXAnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9tYXBUbyc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL21hcCc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL2NhdGNoJztcblxuaW1wb3J0IHtcbiAgSUZBQ0VTX0xPQUQsXG4gIElGQUNFU19MT0FEX1NVQ0NFU1MsXG4gIElGQUNFX1NFVCxcbiAgSUZBQ0VfQ0hBTkdFLFxuICBTVEFUSU9OU19MT0FELFxuICBTVEFUSU9OU19MT0FEX1NVQ0NFU1MsXG4gIFNUQVRJT05fU0VULFxuICBUSU1FUl9TVEFSVCxcbiAgVElNRVJfU1RPUCxcbiAgU0lHTkFMX0dFVCxcbiAgU0lHTkFMX0dFVF9TVUNDRVNTLFxuICBJTklUX0FMSUdOXG59IGZyb20gJy4vYWxpZ25Db25zdGFudHMnO1xuXG5cbi8vIExPQUQgSU5URVJGQUNFUyAtPiBEaXNwYXRjaCBzdWNjZXNzIGFuZCBzdGF0aW9ucyBsb2Fkc1xuY29uc3QgaWZhY2VMb2FkID0gKCBhY3Rpb24kLCB7IGdldFN0YXRlIH0sIHsgd3NBUEkgfSApID0+XG4gIGFjdGlvbiQub2ZUeXBlKC4uLltJRkFDRVNfTE9BRF0pXG4gICAgLm1lcmdlTWFwKChhY3Rpb24pID0+IGdldEludGVyZmFjZXMod3NBUEksIGdldFN0YXRlKCkubWV0YS5zaWQpKVxuICAgICAgLm1lcmdlTWFwKChwYXlsb2FkKSA9PiBPYnNlcnZhYmxlLmZyb20oW1xuICAgICAgICAoeyB0eXBlOiBJRkFDRVNfTE9BRF9TVUNDRVNTLCBwYXlsb2FkIH0pLFxuICAgICAgICAoeyB0eXBlOiBTVEFUSU9OU19MT0FEIH0pXG4gICAgICBdKSk7XG5cblxuLy8gTE9BRCBBTEwgU1RBVElPTlMgLT4gRGlzcGF0Y2ggc3VjY2VzcyBhbmQgSW5pdCBBbGlnblxuY29uc3QgYWxsU3RhdGlvbnNMb2FkID0gKGFjdGlvbiQsIHsgZ2V0U3RhdGUgfSwgeyB3c0FQSSB9ICApID0+XG4gIGFjdGlvbiQub2ZUeXBlKFNUQVRJT05TX0xPQUQpXG4gICAgLm1lcmdlTWFwKCgpID0+IGdldFN0YXRpb25zKHdzQVBJLCBnZXRTdGF0ZSgpLm1ldGEuc2lkKSlcbiAgICAgIC5tYXAoKHBheWxvYWQpID0+ICh7IHR5cGU6IFNUQVRJT05TX0xPQURfU1VDQ0VTUywgcGF5bG9hZCB9KSlcbiAgICAgIC5jYXRjaChlcnJvciA9PiBPYnNlcnZhYmxlLm9mKHtcbiAgICAgICAgdHlwZTogJ05PVElGSUNBVElPTicsXG4gICAgICAgIHBheWxvYWQ6IHsgbXNnOiAnTm90IHN0YXRpb25zIGluIGludGVyZmFjZXMnIH0sXG4gICAgICAgIGVycm9yOiB0cnVlXG4gICAgICB9KSk7XG5cbi8vIENIQU5HRSBJTlRFRkFDRSAtPiBESXNwYXRjaCBnZXQgc3RhdGlvbiBieSBpbnRlcmZhY2UgYW5kIHNlbGVjdCBiZXN0IHNpZ25hbFxuY29uc3QgaWZhY2VDaGFuZ2UgPSAoYWN0aW9uJCwgeyBnZXRTdGF0ZSB9LCB7IHdzQVBJIH0gKSA9PlxuICBhY3Rpb24kLm9mVHlwZShJRkFDRV9DSEFOR0UpXG4gICAgLm1lcmdlTWFwKChhY3Rpb24pID0+IGdldElmYWNlU3RhdGlvbih3c0FQSSwgZ2V0U3RhdGUoKS5tZXRhLnNpZCwgYWN0aW9uLnBheWxvYWQuaWZhY2UpKVxuICAgIC5tYXAoIHBheWxvYWQgPT4gcGF5bG9hZC5ub2RlcylcbiAgICAubWFwKChwYXlsb2FkKSA9PiAoeyB0eXBlOiBTVEFUSU9OU19MT0FEX1NVQ0NFU1MsIHBheWxvYWQgfSkpXG4gICAgLmNhdGNoKGVycm9yID0+IE9ic2VydmFibGUub2Yoe1xuICAgICAgdHlwZTogJ05PVElGSUNBVElPTicsXG4gICAgICBwYXlsb2FkOiB7IG1zZzogJ05vdCBzdGF0aW9ucyBpbiBpbnRlcmZhY2UnIH0sXG4gICAgICBlcnJvcjogdHJ1ZVxuICAgIH0pKTtcblxuLy8gSU5JVCBBTElHTiAtPiBTZWxlY3QgYmVzdCBub2RlLCBpbnRlcmZhY2UgYW5kIHN0YXJ0IHRpbWVyXG5jb25zdCBpbml0QWxpZ24gPSAoYWN0aW9uJCApID0+XG4gIGFjdGlvbiQub2ZUeXBlKFNUQVRJT05TX0xPQURfU1VDQ0VTUylcbiAgICAubWFwKGFjdGlvbiA9PiBhY3Rpb24ucGF5bG9hZClcbiAgICAubWFwKHBheWxvYWQgPT4ge1xuICAgICAgcmV0dXJuIHBheWxvYWQuc29ydCgoeCwgeSkgPT4geC5zaWduYWwgKyB5LnNpZ25hbClbMF07XG4gICAgfSlcbiAgICAubWVyZ2VNYXAoKHJlcykgPT4gT2JzZXJ2YWJsZS5mcm9tKFtcbiAgICAgICAgICAoeyB0eXBlOiBTVEFUSU9OX1NFVCwgcGF5bG9hZDogcmVzIH0pLFxuICAgICAgICAgICh7IHR5cGU6IElGQUNFX1NFVCwgcGF5bG9hZDogcmVzLmlmYWNlIH0pLFxuICAgICAgICAgICh7IHR5cGU6IFRJTUVSX1NUQVJUIH0pXSkpO1xuXG5cbi8vIEdFVF9TSUdOQUwgLT4gVXBkYXRlIGN1cnJlbnQgc2lnbmFsIGFuZCBub2Rlc1xuY29uc3QgZ2V0U2lnbmFsID0gKCBhY3Rpb24kLCB7IGdldFN0YXRlfSwgeyB3c0FQSSB9ICkgPT5cbiAgYWN0aW9uJC5vZlR5cGUoU0lHTkFMX0dFVClcbiAgICAuc3dpdGNoTWFwKCgpID0+IGdldFN0YXRpb25TaWduYWwod3NBUEksIGdldFN0YXRlKCkubWV0YS5zaWQsIGdldFN0YXRlKCkuYWxpZ24uY3VycmVudFJlYWRpbmcpKVxuICAgICAgLm1hcCggc2lnbmFsID0+ICh7IHR5cGU6IFNJR05BTF9HRVRfU1VDQ0VTUywgcGF5bG9hZDogc2lnbmFsIH0pKTtcblxuLy8gVElNRVIgTUFOQUdFUlxuY29uc3QgcnVuVGltZXIgPSAoIGFjdGlvbiQsIHsgZ2V0U3RhdGV9ICkgPT5cbiAgYWN0aW9uJC5vZlR5cGUoVElNRVJfU1RBUlQpXG4gICAgLm1lcmdlTWFwKChhY3Rpb25zKSA9PiB7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5pbnRlcnZhbChnZXRTdGF0ZSgpLm1ldGEuaW50ZXJ2YWwpXG4gICAgICAgIC50YWtlVW50aWwoYWN0aW9uJC5vZlR5cGUoVElNRVJfU1RPUCkpXG4gICAgICAgIC5tYXAoKCkgPT4gKHsgdHlwZTogU0lHTkFMX0dFVCB9KSk7XG4gICAgfSk7XG5cbmV4cG9ydCBkZWZhdWx0IHsgaWZhY2VMb2FkLCBhbGxTdGF0aW9uc0xvYWQsIGlmYWNlQ2hhbmdlLCBpbml0QWxpZ24sIGdldFNpZ25hbCwgcnVuVGltZXJ9OyJdfQ==